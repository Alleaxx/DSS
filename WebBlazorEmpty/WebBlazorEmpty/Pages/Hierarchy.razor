@page "/hierarchy"
@inherits DSSComponent
@layout EditorLayout



<style>



    .basic-border {
        border: 1px solid gainsboro;
        border-radius: 3px;
        margin: 3px;
        padding: 5px;
    }

    .info-sheme {
        flex-basis: 25%;
        display: none;
    }

    .info-node {
        flex-basis: 15%
    }

    .sheme {
        flex-basis: 100%;
    }



    .col-own {
        display: flex;
        flex-direction: column;
    }

    .row-own {
        display: flex;
        flex-direction: row;
    }

    .level {
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid gainsboro;
    }



    .space-between {
        justify-content: space-between;
    }


    .level-name {
        text-align: center;
        width: 150px;
    }
    .level-index{
        color: gray;
    }

    .level-elements {
        display: flex;
        flex-flow: row wrap;
        margin: 5px 0;
    }
    .level-add{

    }

    .node-element {
        padding: 2px 5px;
        padding-right: 0;
        margin: 8px;
        border: 1px solid gray;
        width: 15%;
        min-width: 125px;
        border-radius: 2px;
    }

    .add {
        color: green;
        border: 1px solid lightgreen;
        background: transparent;
        padding: 5px 30px;
    }

        .add:hover {
            background-color: lightgreen;
            cursor: pointer;
        }

    .remove {
        color: red;
        /* height: 2em; */
        font-size: 0.75em;
        margin: 0;
        
        padding: 5px 8px;
        background-color: transparent;
        border: 0;
    }

        .remove:hover {
            background-color: lightpink;
            cursor: pointer;
        }


    .input-text {
        width: 100%;
        font-size: 0.7em;
        border: 0;
        border-right: 1px solid gainsboro;
        padding: 10px 0;
        text-align: center;
    }

    .confirm{
        margin: 10px;
    }

    .new-level{
        margin: 10px 0;
    }
    .main-goal-level{
        flex-basis: 35%;
    }


</style>

<h2 class="content-header-h">Редактирование иерархии задачи выбора</h2>
<div class="row-own">
    <div class="col-own sheme basic-border space-between">


        <div class="confirm">
            @if (Project.UnsavedChanged && Project.ProblemEditing.Correctness.Result)
            {
                <b>Есть несохраненные изменения</b>
                <input class="add" type="button" value="Подтвердить текущую иерархию" @onclick="UpdateHierarchy" />
            }
            else if(Project.UnsavedChanged && !Project.ProblemEditing.Correctness.Result)
            {
                <b>Некорректная структура иерархии</b>
            }
            else
            {
                <b @onclick="UpdateHierarchy">Все изменения сохранены</b>
                <NavLink class="navigation-link" href="/view">
                    [ Обзор задачи ]
                </NavLink>
            }
        </div>
        <div>
            @foreach (var levelGroup in Hierarchies.GroupedByLevel)
            {
                <div class="row-own level">
                    <div class="level-name">
                        <span class="level-index" style="font-size:1em">Уровень @levelGroup.Key</span>
                        <br>
                        <span style="font-size:1.1em">@(HierarchyNodes.GetTextInfo(Hierarchies,levelGroup.Key))</span>
                        <br />

                    </div>
                    <div class="level-elements">
                        @foreach (var node in levelGroup)
                        {
                            <div class="node-element row-own @(levelGroup.Key == 0 ? "main-goal-level" : "")">
                                <input class="input-text" type="text" @bind-value="@node.Name" @onfocus="@( () => SelectedNode = node )" />
                                <input class="remove" type="button" value="X" @onclick="@(() => RemoveNode(node))" />
                            </div>
                        }
                    </div>
                    <div class="level-add">
                        <input class="add" type="button" value="+" @onclick="@(() => AddNode(levelGroup.Key))" />
                    </div>

                </div>
            }
            <div class="row-own level">
                <div class="level-name" style="color:gray">
                    <span style="font-size:1.1em">Уровень @Hierarchies.LevelsCount</span>
                    <br>
                </div>
                <div>
                    <div class="row-own">
                        <input class="add new-level" type="button" value="+" @onclick="@(() => AddNode(Hierarchies.LevelsCount))" />
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div class="info-sheme basic-border">
        @if (SelectedNode != null)
        {
            <h5>Редактирование узла</h5>
            <div class="col">
                <input type="text" @bind-value="@SelectedNode.Name" />
                <input type="button" value="/\" @onclick="@(() => MoveNode(SelectedNode, -1))" />
                <input type="button" value="\/" @onclick="@(() => MoveNode(SelectedNode, 1))" />
            </div>
        }
        <h5>Информация</h5>
        <dl>
            <dt>Уровней иерархии:</dt>
            <dl>@Hierarchies.LevelsCount</dl>

            <dt>Узлов:</dt>
            <dl>@Hierarchies.NodesCount</dl>

            <dt>Отношений:</dt>
            <dd>@Hierarchies.RelationsCount</dd>

            <dt>Максимальный уровень:</dt>
            <dd>@Hierarchies.MaxLevel</dd>

            <dt>Пригодна для использования:</dt>
            <dd>
                @(Hierarchies.Correctness.Result ? "ДА" : "НЕТ")
                @if (Hierarchies.Correctness.Comments.Count > 0)
                {
                    <ol>
                        @foreach (var comment in Hierarchies.Correctness.Comments)
                        {
                            <li>@comment</li>
                        }
                    </ol>

                }
            </dd>

            <dt>Главная цель</dt>
            <dd>@Hierarchies.MainGoal.Name</dd>

            <dt>Критерии:</dt>
            <dd>@string.Join(',', Hierarchies.Criterias.Select(c => c.Name))</dd>

            <dt>Альтернативы:</dt>
            <dd>@string.Join(',', Hierarchies.Alternatives.Select(c => c.Name))</dd>
        </dl>
    </div>
</div>



@code {
    private IHierarchy Hierarchies => Project.ProblemEditing;
    private List<INode> Nodes => Project.NodesEditing;

    const string Sheme = "По описанию";
    const string Information = "По рейтингу критериев";


    public string[] Filters { get; set; } = new string[]
    {
            Sheme,
            Information,
            };
    private string Filter { get; set; }


    //Подтверждение иерархии
    private void UpdateHierarchy() => Project.UpdateProblem();


    //Редактирование иерархии
    private INode SelectedNode { get; set; }
    private void AddNode(int level = -1)
    {
        level = level == -1 ? Hierarchies.LevelsCount - 1 : level;
        INode newNode = new Node(level, "Узел");
        Nodes.Add(newNode);
    }
    private void MoveNode(INode node, int inc)
    {
        int newLevel = node.Level + inc;
        if (newLevel >= 0)
            node.Level = newLevel;
    }
    private void RemoveNode(INode e)
    {
        SelectedNode = Nodes.First();
        if (e != Hierarchies.MainGoal)
            Nodes.Remove(e);
    }
}
